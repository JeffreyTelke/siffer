#!/usr/bin/env ruby

require 'rubygems'
require 'optparse'
require 'yaml'
libdir = File.join(File.dirname(__FILE__),"..","lib")
$LOAD_PATH.unshift(libdir) unless $LOAD_PATH.include?(libdir)
require 'siffer'

options = {:environment => "development"}

opts = OptionParser.new("", 24, ' ') { |opts| 
  opts.banner = "Usage: siffer [start|run|stop|kill] [component] [options]"
  
  opts.separator ""
  opts.separator "[component] can be admin or the file path to your downloaded component"
  opts.separator ""
  opts.separator "Example:"
  
  opts.separator "Siffer options:"
  
  opts.on("-e", 
          "--env ENVIRONMENT", 
          "development, deployment, test, none (default: development)") { |e|
    options[:environment] = e
  }
   
  opts.on("-d", 
          "--daemonize", 
          "run daemonized in the background (default: true)") { |d|
    options[:daemonize] = d ? true : false
  }
  
  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end

  opts.on_tail("-v", "--version", "Show version") do
   puts "Siffer #{Siffer.version} (SIF Version #{Siffer.sif_version})"
   exit
  end

  opts.parse! ARGV
}

unless command = ARGV[0]
  abort opts.to_s
end

unless options[:component] = ARGV[1]
  abort opts.to_s
end

if options[:component] == "admin"
  options[:config] = {"admin" => {}}
else
  options[:config] = YAML.load_file(File.expand_path(options[:component]))
end

component = options[:component].split('/')[-1]
cwd = File.expand_path(File.dirname(options[:component]))
options[:log] = File.join(cwd,"#{component}.log")
options[:pid] = File.join(cwd,"#{component}.pid")
container = Siffer::Container.new(options)
if command == "start" or command == "run"
  if options[:environment] == "test"
    puts options.inspect # For testing purposes let's just output the options
  else
    if component == "admin"
      puts "Siffer Central Admin has been started!"
    else
      puts "Siffer Component: #{component} has been started!"
    end
    puts "You can see it here: http://#{container.host}:#{container.port}"
    container.run
  end
else
  container.stop
end



